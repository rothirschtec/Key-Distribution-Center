#!/bin/bash
# VPN Setup Script for {{ cn }}
# Generated by KDC Web Application

set -e

P12_FILE="{{ p12_filename }}"
P12_PASSWORD="{{ p12_password }}"
VPN_GATEWAY="{{ vpn_gateway }}"
CN="{{ cn }}"
CONN_NAME="{{ cn | replace('.', '-') | replace('@', '-') }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== VPN Setup Script ===${NC}"
echo -e "Certificate: ${CN}"
echo -e "Gateway: ${VPN_GATEWAY}"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Please run as root (sudo ./vpn-setup.sh)${NC}"
    exit 1
fi

# Check if P12 file exists
if [ ! -f "$P12_FILE" ]; then
    echo -e "${RED}Error: P12 file not found: ${P12_FILE}${NC}"
    echo "Please ensure the P12 file is in the same directory as this script."
    exit 1
fi

# Detect package manager
if command -v apt &> /dev/null; then
    PKG_MANAGER="apt"
    INSTALL_CMD="apt install -y"
elif command -v dnf &> /dev/null; then
    PKG_MANAGER="dnf"
    INSTALL_CMD="dnf install -y"
elif command -v yum &> /dev/null; then
    PKG_MANAGER="yum"
    INSTALL_CMD="yum install -y"
elif command -v pacman &> /dev/null; then
    PKG_MANAGER="pacman"
    INSTALL_CMD="pacman -S --noconfirm"
else
    echo -e "${RED}Error: No supported package manager found${NC}"
    exit 1
fi

echo -e "${YELLOW}Installing strongSwan...${NC}"
case $PKG_MANAGER in
    apt)
        apt update
        $INSTALL_CMD strongswan strongswan-swanctl libcharon-extra-plugins
        ;;
    dnf|yum)
        $INSTALL_CMD strongswan
        ;;
    pacman)
        $INSTALL_CMD strongswan
        ;;
esac

echo -e "${GREEN}strongSwan installed successfully${NC}"

# Create directories
echo -e "${YELLOW}Creating certificate directories...${NC}"
mkdir -p /etc/swanctl/x509ca
mkdir -p /etc/swanctl/x509
mkdir -p /etc/swanctl/private
mkdir -p /etc/swanctl/conf.d

# Extract certificates from P12
echo -e "${YELLOW}Extracting certificates from P12...${NC}"

# Extract CA certificate
openssl pkcs12 -in "$P12_FILE" -cacerts -nokeys \
    -out /etc/swanctl/x509ca/ca-${CONN_NAME}.pem \
    -password pass:"$P12_PASSWORD" 2>/dev/null || true

# Extract client certificate
openssl pkcs12 -in "$P12_FILE" -clcerts -nokeys \
    -out /etc/swanctl/x509/${CONN_NAME}.pem \
    -password pass:"$P12_PASSWORD"

# Extract private key
openssl pkcs12 -in "$P12_FILE" -nocerts -nodes \
    -out /etc/swanctl/private/${CONN_NAME}.key \
    -password pass:"$P12_PASSWORD"

# Secure the private key
chmod 600 /etc/swanctl/private/${CONN_NAME}.key

echo -e "${GREEN}Certificates extracted successfully${NC}"

# Create swanctl configuration
echo -e "${YELLOW}Creating swanctl configuration...${NC}"
cat > /etc/swanctl/conf.d/${CONN_NAME}.conf << 'SWANCTL_EOF'
connections {
    {{ cn | replace('.', '-') | replace('@', '-') }} {
        remote_addrs = {{ vpn_gateway }}
        vips = 0.0.0.0

        local {
            auth = pubkey
            certs = {{ cn | replace('.', '-') | replace('@', '-') }}.pem
        }

        remote {
            auth = pubkey
            id = {{ vpn_gateway }}
        }

        children {
            {{ cn | replace('.', '-') | replace('@', '-') }} {
                remote_ts = 0.0.0.0/0
                start_action = trap
                dpd_action = restart
            }
        }
    }
}
SWANCTL_EOF

echo -e "${GREEN}Configuration created${NC}"

# Create systemd service for this VPN connection
echo -e "${YELLOW}Creating systemd service...${NC}"
cat > /etc/systemd/system/strongswan-${CONN_NAME}.service << SYSTEMD_EOF
[Unit]
Description=strongSwan VPN - ${CN}
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/sbin/swanctl --load-all
ExecStart=/usr/sbin/swanctl -i -c ${CONN_NAME}
ExecStop=/usr/sbin/swanctl -t -c ${CONN_NAME}

[Install]
WantedBy=multi-user.target
SYSTEMD_EOF

# Reload systemd
systemctl daemon-reload

echo -e "${GREEN}Systemd service created: strongswan-${CONN_NAME}${NC}"

# Load the configuration
echo -e "${YELLOW}Loading strongSwan configuration...${NC}"
systemctl start strongswan-starter 2>/dev/null || systemctl start strongswan 2>/dev/null || true
sleep 2
swanctl --load-all

echo ""
echo -e "${GREEN}=== Setup Complete ===${NC}"
echo ""
echo "Usage:"
echo "  Connect:    sudo swanctl -i -c ${CONN_NAME}"
echo "  Disconnect: sudo swanctl -t -c ${CONN_NAME}"
echo "  Status:     sudo swanctl -l"
echo ""
echo "Systemd service:"
echo "  Start:      sudo systemctl start strongswan-${CONN_NAME}"
echo "  Stop:       sudo systemctl stop strongswan-${CONN_NAME}"
echo "  Enable:     sudo systemctl enable strongswan-${CONN_NAME}"
echo "  Status:     sudo systemctl status strongswan-${CONN_NAME}"
echo ""
echo -e "${YELLOW}Note: You may need to restart strongswan for changes to take effect:${NC}"
echo "  sudo systemctl restart strongswan-starter"
