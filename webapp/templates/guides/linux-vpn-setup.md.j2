# Linux VPN Setup Guide - IKEv2 with X.509 Certificate

## Certificate Information

- **Common Name (CN):** {{ cn }}
- **P12 File:** {{ p12_filename }}
- **P12 Password:** *Provided separately by your administrator*
- **VPN Gateway:** {{ vpn_gateway }}

## Option 1: GNOME Network Manager (GUI)

### Prerequisites

Install required packages:

```bash
sudo apt install network-manager-strongswan libcharon-extra-plugins libstrongswan-extra-plugins
```

### Step 1: Extract Certificates from P12

GNOME Network Manager needs separate certificate and key files.

**Set your password first (provided by your administrator), then copy-paste the entire block:**

```bash
# === SET YOUR PASSWORD HERE ===
P12_PASSWORD="YOUR_PASSWORD_HERE"

# Create directory and extract certificates
mkdir -p ~/.config/vpn-certs

# Extract CA certificate
openssl pkcs12 -in {{ p12_filename }} -cacerts -nokeys \
    -out ~/.config/vpn-certs/ca.pem \
    -password pass:"$P12_PASSWORD" -legacy 2>/dev/null || \
openssl pkcs12 -in {{ p12_filename }} -cacerts -nokeys \
    -out ~/.config/vpn-certs/ca.pem \
    -password pass:"$P12_PASSWORD"

# Extract client certificate
openssl pkcs12 -in {{ p12_filename }} -clcerts -nokeys \
    -out ~/.config/vpn-certs/{{ cn }}.crt \
    -password pass:"$P12_PASSWORD" -legacy 2>/dev/null || \
openssl pkcs12 -in {{ p12_filename }} -clcerts -nokeys \
    -out ~/.config/vpn-certs/{{ cn }}.crt \
    -password pass:"$P12_PASSWORD"

# Extract private key (unencrypted to avoid password prompts)
openssl pkcs12 -in {{ p12_filename }} -nocerts -nodes \
    -out ~/.config/vpn-certs/{{ cn }}.key \
    -password pass:"$P12_PASSWORD" -legacy 2>/dev/null || \
openssl pkcs12 -in {{ p12_filename }} -nocerts -nodes \
    -out ~/.config/vpn-certs/{{ cn }}.key \
    -password pass:"$P12_PASSWORD"

# Secure the private key
chmod 600 ~/.config/vpn-certs/{{ cn }}.key
```

### Step 2: Get Your Exact Identity String

**This is the most important step!** Run this command to get your exact identity:

```bash
openssl x509 -in ~/.config/vpn-certs/{{ cn }}.crt -noout -subject -nameopt RFC2253 | sed 's/subject=//'
```

This will output something like:
```
CN={{ cn }},O={{ company }},C={{ country }}
```

**Copy this exact output** - you will need it for the "Identity" field below.

### Step 3: Configure VPN in GNOME Settings

1. Open **Settings** → **Network**
2. Click **+** next to VPN
3. Select **IPsec/IKEv2 (strongswan)**
4. Configure the **Identity** tab:

**Server Section:**

| Setting | Value |
|---------|-------|
| **Name** | {{ cn }} VPN |
| **Address** | {{ vpn_gateway }} |
| **Certificate** | Select `~/.config/vpn-certs/ca.pem` |
| **Identity** | *Leave empty* |

**Client Section (YOUR identity):**

| Setting | Value |
|---------|-------|
| **Authentication** | **Certificate** (NOT EAP!) |
| **Certificate** | **Certificate/private key** |
| **Certificate file** | Select `~/.config/vpn-certs/{{ cn }}.crt` |
| **Private key** | Select `~/.config/vpn-certs/{{ cn }}.key` |
| **Identity** | ⚠️ **Paste the output from Step 2** ← *NOT the server name!* |

> **⚠️ CRITICAL:**
> - **Server Identity** = Leave empty
> - **Client Identity** = Your certificate DN from Step 2 (e.g., `CN={{ cn }},O={{ company }},C={{ country }}`)

**Options Section:**

| Setting | Value |
|---------|-------|
| **Request an inner IP address** | ✓ Checked |
| **Enforce UDP encapsulation** | ✓ Checked |

5. Click **Add**

### Step 4: Connect

Click the VPN toggle in Settings or use the network indicator in the top bar.

---

## Option 2: strongSwan CLI (Recommended for Servers)

### Installation

Run the included setup script:

```bash
chmod +x vpn-setup.sh
sudo ./vpn-setup.sh
```

Or manually:

```bash
sudo apt install strongswan libcharon-extra-plugins
```

### Manual Configuration

1. **Extract P12 certificate (set your password first, then copy-paste the block):**

```bash
# === SET YOUR PASSWORD HERE ===
P12_PASSWORD="YOUR_PASSWORD_HERE"

# Extract CA certificate
openssl pkcs12 -in {{ p12_filename }} -cacerts -nokeys -out /etc/swanctl/x509ca/ca.pem -password pass:"$P12_PASSWORD"

# Extract client certificate
openssl pkcs12 -in {{ p12_filename }} -clcerts -nokeys -out /etc/swanctl/x509/{{ cn }}.pem -password pass:"$P12_PASSWORD"

# Extract private key
openssl pkcs12 -in {{ p12_filename }} -nocerts -nodes -out /etc/swanctl/private/{{ cn }}.key -password pass:"$P12_PASSWORD"
chmod 600 /etc/swanctl/private/{{ cn }}.key
```

2. **Create swanctl configuration** (`/etc/swanctl/conf.d/{{ cn }}.conf`):

```ini
connections {
    {{ cn | replace('.', '-') | replace('@', '-') }} {
        remote_addrs = {{ vpn_gateway }}
        vips = 0.0.0.0

        local {
            auth = pubkey
            certs = {{ cn }}.pem
            id = "C={{ country }}, O={{ company }}, CN={{ cn }}"
        }

        remote {
            auth = pubkey
            id = {{ vpn_gateway }}
        }

        children {
            {{ cn | replace('.', '-') | replace('@', '-') }} {
                remote_ts = 0.0.0.0/0
                start_action = trap
            }
        }
    }
}
```

3. **Load configuration:**

```bash
sudo swanctl --load-all
```

4. **Connect:**

```bash
sudo swanctl -i -c {{ cn | replace('.', '-') | replace('@', '-') }}
```

### Using the systemd Service

The included `vpn-setup.sh` script creates a systemd service for easy management:

```bash
# Start VPN
sudo systemctl start strongswan-{{ cn | replace('.', '-') | replace('@', '-') }}

# Stop VPN
sudo systemctl stop strongswan-{{ cn | replace('.', '-') | replace('@', '-') }}

# Enable on boot
sudo systemctl enable strongswan-{{ cn | replace('.', '-') | replace('@', '-') }}

# Check status
sudo systemctl status strongswan-{{ cn | replace('.', '-') | replace('@', '-') }}
```

---

## Troubleshooting

### Check Connection Status

```bash
sudo swanctl -l
```

### View Logs

```bash
sudo journalctl -u strongswan -f
```

### Common Issues

1. **Certificate not trusted:** Ensure the CA certificate is in `/etc/swanctl/x509ca/`
2. **Connection timeout:** Check firewall allows UDP 500 and 4500
3. **Authentication failed:** Verify P12 password and certificate paths
