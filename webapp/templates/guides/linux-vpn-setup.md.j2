# Linux VPN Setup Guide - IKEv2 with X.509 Certificate

## Certificate Information

- **Common Name (CN):** {{ cn }}
- **P12 File:** {{ p12_filename }}
- **P12 Password:** {{ p12_password }}
- **VPN Gateway:** {{ vpn_gateway }}

## Option 1: GNOME Network Manager (GUI)

### Prerequisites

Install required packages:

```bash
sudo apt install network-manager-strongswan libcharon-extra-plugins libstrongswan-extra-plugins
```

### Step 1: Extract Certificates from P12

GNOME Network Manager needs separate certificate and key files. Run these commands:

```bash
# Create a directory for the certificates
mkdir -p ~/.config/vpn-certs

# Extract the CA certificate
openssl pkcs12 -in {{ p12_filename }} -cacerts -nokeys \
    -out ~/.config/vpn-certs/ca.pem \
    -password pass:'{{ p12_password }}' -legacy 2>/dev/null || \
openssl pkcs12 -in {{ p12_filename }} -cacerts -nokeys \
    -out ~/.config/vpn-certs/ca.pem \
    -password pass:'{{ p12_password }}'

# Extract your client certificate
openssl pkcs12 -in {{ p12_filename }} -clcerts -nokeys \
    -out ~/.config/vpn-certs/{{ cn }}.crt \
    -password pass:'{{ p12_password }}' -legacy 2>/dev/null || \
openssl pkcs12 -in {{ p12_filename }} -clcerts -nokeys \
    -out ~/.config/vpn-certs/{{ cn }}.crt \
    -password pass:'{{ p12_password }}'

# Extract your private key (unencrypted with -nodes to avoid password prompts)
openssl pkcs12 -in {{ p12_filename }} -nocerts -nodes \
    -out ~/.config/vpn-certs/{{ cn }}.key \
    -password pass:'{{ p12_password }}' -legacy 2>/dev/null || \
openssl pkcs12 -in {{ p12_filename }} -nocerts -nodes \
    -out ~/.config/vpn-certs/{{ cn }}.key \
    -password pass:'{{ p12_password }}'

# IMPORTANT: Secure the private key since it's unencrypted
chmod 600 ~/.config/vpn-certs/{{ cn }}.key
```

### Step 2: Configure VPN in GNOME Settings

1. Open **Settings** → **Network**
2. Click **+** next to VPN
3. Select **IPsec/IKEv2 (strongswan)**
4. Configure the **Identity** tab:

**Server Section:**

| Setting | Value |
|---------|-------|
| **Name** | {{ cn }} VPN |
| **Address** | {{ vpn_gateway }} |
| **Certificate** | Select `~/.config/vpn-certs/ca.pem` |
| **Identity** | {{ vpn_gateway }} |

**Client Section:**

| Setting | Value |
|---------|-------|
| **Authentication** | **Certificate** (NOT EAP!) |
| **Certificate** | **Certificate/private key** |
| **Certificate file** | Select `~/.config/vpn-certs/{{ cn }}.crt` |
| **Private key** | Select `~/.config/vpn-certs/{{ cn }}.key` |
| **Identity** | `C={{ country }}, O={{ company }}, CN={{ cn }}` |

> **Important:** The Identity must be the **full DN** (Distinguished Name) exactly as shown above.
> Using just the CN (e.g., `{{ cn }}`) will NOT work due to a GNOME/charon-nm quirk
> that converts `@` to `.` in simple identity strings.

**Options Section:**

| Setting | Value |
|---------|-------|
| **Request an inner IP address** | ✓ Checked |
| **Enforce UDP encapsulation** | ✓ Checked |

5. Click **Add**

### Step 3: Connect

Click the VPN toggle in Settings or use the network indicator in the top bar.

---

## Option 2: strongSwan CLI (Recommended for Servers)

### Installation

Run the included setup script:

```bash
chmod +x vpn-setup.sh
sudo ./vpn-setup.sh
```

Or manually:

```bash
sudo apt install strongswan libcharon-extra-plugins
```

### Manual Configuration

1. **Extract P12 certificate:**

```bash
# Extract CA certificate
openssl pkcs12 -in {{ p12_filename }} -cacerts -nokeys -out /etc/swanctl/x509ca/ca.pem -password pass:{{ p12_password }}

# Extract client certificate
openssl pkcs12 -in {{ p12_filename }} -clcerts -nokeys -out /etc/swanctl/x509/{{ cn }}.pem -password pass:{{ p12_password }}

# Extract private key
openssl pkcs12 -in {{ p12_filename }} -nocerts -nodes -out /etc/swanctl/private/{{ cn }}.key -password pass:{{ p12_password }}
chmod 600 /etc/swanctl/private/{{ cn }}.key
```

2. **Create swanctl configuration** (`/etc/swanctl/conf.d/{{ cn }}.conf`):

```ini
connections {
    {{ cn | replace('.', '-') | replace('@', '-') }} {
        remote_addrs = {{ vpn_gateway }}
        vips = 0.0.0.0

        local {
            auth = pubkey
            certs = {{ cn }}.pem
            id = "C={{ country }}, O={{ company }}, CN={{ cn }}"
        }

        remote {
            auth = pubkey
            id = {{ vpn_gateway }}
        }

        children {
            {{ cn | replace('.', '-') | replace('@', '-') }} {
                remote_ts = 0.0.0.0/0
                start_action = trap
            }
        }
    }
}
```

3. **Load configuration:**

```bash
sudo swanctl --load-all
```

4. **Connect:**

```bash
sudo swanctl -i -c {{ cn | replace('.', '-') | replace('@', '-') }}
```

### Using the systemd Service

The included `vpn-setup.sh` script creates a systemd service for easy management:

```bash
# Start VPN
sudo systemctl start strongswan-{{ cn | replace('.', '-') | replace('@', '-') }}

# Stop VPN
sudo systemctl stop strongswan-{{ cn | replace('.', '-') | replace('@', '-') }}

# Enable on boot
sudo systemctl enable strongswan-{{ cn | replace('.', '-') | replace('@', '-') }}

# Check status
sudo systemctl status strongswan-{{ cn | replace('.', '-') | replace('@', '-') }}
```

---

## Troubleshooting

### Check Connection Status

```bash
sudo swanctl -l
```

### View Logs

```bash
sudo journalctl -u strongswan -f
```

### Common Issues

1. **Certificate not trusted:** Ensure the CA certificate is in `/etc/swanctl/x509ca/`
2. **Connection timeout:** Check firewall allows UDP 500 and 4500
3. **Authentication failed:** Verify P12 password and certificate paths
