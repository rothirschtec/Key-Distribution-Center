{% extends "base.html" %}

{% block title %}Certificate: {{ cert.subject_cn or cert.cn }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Certificate: {{ cert.subject_cn or cert.cn or 'Unknown' }}</h1>
    <a href="{{ url_for('web.list_certificates') }}" class="btn btn-secondary">Back to List</a>
</div>

<div class="detail-card">
    <h2>Certificate Details</h2>
    <dl class="detail-list">
        <dt>Subject</dt>
        <dd>{{ cert.subject or 'Unknown' }}</dd>

        <dt>Issuer</dt>
        <dd>{{ cert.issuer or 'Unknown' }}</dd>

        <dt>Serial Number</dt>
        <dd><code>{{ cert.serial or 'Unknown' }}</code></dd>

        <dt>Not Before</dt>
        <dd>{{ cert.not_before or 'Unknown' }}</dd>

        <dt>Not After</dt>
        <dd>{{ cert.not_after or 'Unknown' }}</dd>

        <dt>Public Key</dt>
        <dd>{{ cert.pubkey_type or 'Unknown' }} {{ cert.pubkey_bits or '' }} bits</dd>

        {% if cert.san %}
        <dt>Subject Alternative Names</dt>
        <dd>{{ cert.san }}</dd>
        {% endif %}

        <dt>Certificate Path</dt>
        <dd><code>{{ cert.cert_path }}</code></dd>

        {% if cert.key_path %}
        <dt>Key Path</dt>
        <dd><code>{{ cert.key_path }}</code></dd>
        {% endif %}

        <dt>P12 Bundle</dt>
        <dd>
            {% if cert.p12_path %}
            <code>{{ cert.p12_path }}</code>
            <a href="{{ url_for('web.download_p12', cn=cert.subject_cn or cert.cn) }}" class="btn btn-small btn-primary" style="margin-left: 10px;">Download P12</a>
            {% else %}
            <span style="color: #666;">Not generated</span>
            <form method="POST" action="{{ url_for('web.generate_p12', cn=cert.subject_cn or cert.cn) }}" class="inline-form" style="display: inline;">
                <button type="submit" class="btn btn-small btn-secondary" style="margin-left: 10px;">Generate P12</button>
            </form>
            {% endif %}
        </dd>

        {% if cert.p12_password %}
        <dt>P12 Password</dt>
        <dd>
            <code id="p12-password" style="display: none;">{{ cert.p12_password }}</code>
            <span id="p12-password-hidden">••••••••••••••••••••••</span>
            <button type="button" class="btn btn-small" onclick="togglePassword()">Show/Hide</button>
            <button type="button" class="btn btn-small" onclick="copyPassword()">Copy</button>
        </dd>
        {% endif %}

        <dt>Status</dt>
        <dd>
            {% if cert.is_expired %}
                <span class="badge badge-danger">Expired</span>
            {% else %}
                <span class="badge badge-success">Valid</span>
            {% endif %}
        </dd>
    </dl>
</div>

<div class="section">
    <h2>VPN Setup Bundles</h2>
    <p style="margin-bottom: 15px; color: #666;">Download a ZIP archive containing the P12 certificate and setup instructions for your operating system.</p>
    <div class="action-buttons">
        <a href="{{ url_for('web.download_vpn_bundle', cn=cert.subject_cn or cert.cn, target_os='linux') }}"
           class="btn btn-primary" style="margin-right: 10px;">
            <span style="margin-right: 5px;">&#128039;</span> Linux Bundle
        </a>
        <a href="{{ url_for('web.download_vpn_bundle', cn=cert.subject_cn or cert.cn, target_os='mac') }}"
           class="btn btn-primary" style="margin-right: 10px;">
            <span style="margin-right: 5px;">&#63743;</span> macOS Bundle
        </a>
        <a href="{{ url_for('web.download_vpn_bundle', cn=cert.subject_cn or cert.cn, target_os='windows') }}"
           class="btn btn-primary">
            <span style="margin-right: 5px;">&#128187;</span> Windows Bundle
        </a>
    </div>
    <p style="margin-top: 15px; font-size: 0.9em; color: #888;">
        Each bundle includes: P12 certificate, setup guide, and (for Linux) an automated installation script.
    </p>
</div>

<div class="section">
    <h2>Actions</h2>
    <div class="action-buttons">
        <form method="POST" action="{{ url_for('web.transfer_certificate', cn=cert.subject_cn or cert.cn) }}" class="inline-form">
            <button type="submit" class="btn btn-primary"
                    onclick="return confirm('Transfer this certificate to the IPSEC gateway?');">
                Transfer to Gateway
            </button>
        </form>

        <form method="POST" action="{{ url_for('web.reissue_certificate', cn=cert.subject_cn or cert.cn) }}" class="inline-form">
            <button type="submit" class="btn btn-warning"
                    onclick="return confirm('Reissue this certificate? This will revoke the current certificate.');">
                Reissue
            </button>
        </form>

        <form method="POST" action="{{ url_for('web.revoke_certificate', cn=cert.subject_cn or cert.cn) }}" class="inline-form">
            <button type="submit" class="btn btn-danger"
                    onclick="return confirm('Revoke this certificate? This action cannot be undone.');">
                Revoke
            </button>
        </form>

        <form method="POST" action="{{ url_for('web.delete_certificate', cn=cert.subject_cn or cert.cn) }}" class="inline-form">
            <button type="submit" class="btn btn-danger"
                    onclick="return confirm('Delete this certificate? This action cannot be undone.');">
                Delete
            </button>
        </form>
    </div>
</div>

{% if cert.raw_output %}
<div class="section">
    <h2>Raw Certificate Info</h2>
    <pre class="code-block">{{ cert.raw_output }}</pre>
</div>
{% endif %}

<script>
function togglePassword() {
    var pw = document.getElementById('p12-password');
    var hidden = document.getElementById('p12-password-hidden');
    if (pw.style.display === 'none') {
        pw.style.display = 'inline';
        hidden.style.display = 'none';
    } else {
        pw.style.display = 'none';
        hidden.style.display = 'inline';
    }
}

function copyPassword() {
    var pw = document.getElementById('p12-password').textContent;
    navigator.clipboard.writeText(pw).then(function() {
        alert('Password copied to clipboard!');
    });
}
</script>
{% endblock %}
